# Connect to Azure AD and Azure if not already connected
if (!(Get-AzureADSignedInUser)) { Connect-AzureAD }
if (!(Get-AzContext)) { Connect-AzAccount }

# Get all disabled Azure AD user accounts
$disabledAccounts = Get-AzureADUser -All $true | Where-Object { $_.AccountEnabled -eq $false }

# Initialize an array to hold results
$results = @()

# Iterate over all subscriptions
$subscriptions = Get-AzSubscription
foreach ($sub in $subscriptions) {
    # Set the context to the subscription
    Set-AzContext -SubscriptionId $sub.Id
    
    # Get all role assignments in the subscription
    $roleAssignments = Get-AzRoleAssignment
    
    foreach ($assignment in $roleAssignments) {
        # Check if the principal matches any of the disabled accounts
        $disabledUser = $disabledAccounts | Where-Object { $_.ObjectId -eq $assignment.ObjectId }
        
        if ($disabledUser) {
            $results += [PSCustomObject]@{
                SubscriptionName = $sub.Name
                ResourceName     = $assignment.Scope
                Role             = $assignment.RoleDefinitionName
                UserPrincipal    = $disabledUser.UserPrincipalName
                DisplayName      = $disabledUser.DisplayName
            }
        }
    }
}

# Output the results
if ($results.Count -eq 0) {
    Write-Output "No disabled accounts with access to Azure resources found."
} else {
    $results | Format-Table -AutoSize
    # Export results to a CSV file
    $results | Export-Csv -Path "DisabledAccountsAccess.csv" -NoTypeInformation
    Write-Output "Results exported to DisabledAccountsAccess.csv"
}