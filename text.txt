# Define your subscriptions
$subscriptions = @(
    "SUBSCRIPTION_ID_1",
    "SUBSCRIPTION_ID_2"
)

# Output file
$outputFile = "KeyVaultOwnersReport.csv"

# Initialize result array
$results = @()

foreach ($sub in $subscriptions) {
    az account set --subscription $sub

    $keyVaults = az keyvault list --query "[].{name:name, resourceGroup:resourceGroup}" -o json | ConvertFrom-Json

    foreach ($kv in $keyVaults) {
        $vaultName = $kv.name
        $resourceGroup = $kv.resourceGroup

        # Try to get tags from Key Vault
        $kvTags = az resource show --ids $(az keyvault show -n $vaultName --query id -o tsv) --query tags -o json | ConvertFrom-Json

        # Fallback: try getting tags from resource group if not found in Key Vault
        if (-not $kvTags) {
            $kvTags = az group show --name $resourceGroup --query tags -o json | ConvertFrom-Json
        }

        # Find Primary Contact
        $owner = "Unknown"
        foreach ($key in "PrimaryContact", "primaryContact", "primary_contact") {
            if ($kvTags.ContainsKey($key)) {
                $owner = $kvTags[$key]
                break
            }
        }

        # Add to results
        $results += [PSCustomObject]@{
            Subscription   = $sub
            KeyVaultName   = $vaultName
            ResourceGroup  = $resourceGroup
            Owner          = $owner
        }
    }
}

# Export to CSV
$results | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8

Write-Host "Key Vault ownership report saved to $outputFile"
