param(
    # Resource group that contains the VMs
    [Parameter(Mandatory = $true)]
    [string]$ResourceGroupName,

    # One or more VM names
    [Parameter(Mandatory = $true)]
    [string[]]$VMNames,

    # What to do: Start or Stop
    [Parameter(Mandatory = $true)]
    [ValidateSet("Start", "Stop")]
    [string]$Action
)

# Connect using the Automation Account's managed identity
# (Make sure you've enabled System-assigned identity and given it
# at least "Virtual Machine Contributor" on the RG or subscription.)
Connect-AzAccount -Identity

foreach ($vmName in $VMNames) {
    try {
        $vm = Get-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -Status -ErrorAction Stop
        $powerState = ($vm.Statuses | Where-Object { $_.Code -like "PowerState/*" }).DisplayStatus

        Write-Output "[$vmName] Current state: $powerState"

        switch ($Action) {
            "Start" {
                if ($powerState -eq "VM running") {
                    Write-Output "[$vmName] Already running. Skipping."
                }
                else {
                    Write-Output "[$vmName] Starting..."
                    Start-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -ErrorAction Stop
                    Write-Output "[$vmName] Start command sent."
                }
            }
            "Stop" {
                if ($powerState -eq "VM deallocated" -or $powerState -eq "VM stopped") {
                    Write-Output "[$vmName] Already stopped/deallocated. Skipping."
                }
                else {
                    Write-Output "[$vmName] Stopping (deallocating)..."
                    Stop-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -Force -ErrorAction Stop
                    Write-Output "[$vmName] Stop command sent."
                }
            }
        }
    }
    catch {
        Write-Error "[$vmName] Failed to $Action. Error: $($_.Exception.Message)"
    }
}