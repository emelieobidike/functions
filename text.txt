<#
PenLab VNet + resources builder (Az PowerShell)
Creates: RG, VNet, Subnets, NSGs, VMs (DC + servers), optional JumpBox/Bastion, and auto-promotes DC to AD (penlab.local).
Author: Assistant (example)
#>

# ---------------------------
# PARAMETERS - edit as required
# ---------------------------
# Subscription / Location
$SubscriptionId = ""   # optional: fill or leave blank to use current context
$Location       = "eastus2"
$RGName         = "rg_penlab_PenLab"

# VNet and subnets matching diagram
$VNetName       = "vnet_penlab"
$VNetPrefix     = "10.199.0.0/16"

$SubnetDCName   = "snet-DC"
$SubnetDCPrefix = "10.199.1.0/24"
$SubnetAppName  = "snet-Servers"
$SubnetAppPref  = "10.199.2.0/24"
$SubnetJumpName = "AzureBastionSubnet"          # required name for Azure Bastion if used
$SubnetJumpPref = "10.199.254.0/26"

# VM definitions (names reflect the diagram)
$VMNetworkSize = "Standard_DS1_v2"
$VMList = @(
    @{ Name="SAZE-PENLAB-DC01"; Size="Standard_DS2_v2"; Subnet=$SubnetDCName; PrivateIP="10.199.1.10" },
    @{ Name="SAZE-PENLAB-B01"; Size="Standard_DS1_v2"; Subnet=$SubnetAppName; PrivateIP="10.199.2.11" },
    @{ Name="SAZE-PENLAB-S19"; Size="Standard_DS1_v2"; Subnet=$SubnetAppName; PrivateIP="10.199.2.12" },
    @{ Name="SAZE-PENLAB-S22"; Size="Standard_DS1_v2"; Subnet=$SubnetAppName; PrivateIP="10.199.2.13" },
    @{ Name="SAZE-PENLAB-C11"; Size="Standard_DS1_v2"; Subnet=$SubnetAppName; PrivateIP="10.199.2.14" }
)

# Jumpbox / Bastion options
$UseAzureBastion = $false   # set to $true to create Azure Bastion (requires AzureBastionSubnet and Standard SKU public IP)
$CreateJumpBoxVM = $true    # set to $false if you will use Bastion

$JumpBoxName = "jumpbox-penlab"
$JumpBoxSubnet = $SubnetJumpName
$JumpBoxSize = "Standard_B1ms"

# Domain info (for automatic DC promotion)
$DomainName = "penlab.local"
$DomainNetbios = "PENLAB"

# Tags
$Tags = @{ Project="PenLab"; Environment="PenTest" }

# ------------------------
# Start - ensure Az present
# ------------------------
if (-not (Get-Module -ListAvailable -Name Az)) {
    Install-Module -Name Az -Scope CurrentUser -Force
}
Import-Module Az -ErrorAction Stop

if ($SubscriptionId -ne "") {
    Set-AzContext -SubscriptionId $SubscriptionId
}

# Ask for VM admin credential (local admin used to create VM & initial admin)
Write-Host "Enter local admin credential to use for VMs (lab admin)."
$vmCred = Get-Credential -Message "Provide local admin credential for the VMs (e.g. labadmin)."

# Ask for AD safe mode password for the DC promotion (this will be used as DSRM password)
Write-Host "Enter SafeMode (DSRM) password for the AD promotion (will be stored in memory only)."
$dsrmCred = Read-Host -AsSecureString "Type DSRM password (SecureString)"

# -------------------------
# Create resource group
# -------------------------
Write-Host "Creating resource group $RGName in $Location..."
$rg = New-AzResourceGroup -Name $RGName -Location $Location -Tag $Tags -Force

# -------------------------
# Create NSGs and rules
# -------------------------
Write-Host "Creating Network Security Groups..."
# NSG for DC (allow required inbound for domain services from VNet & jumpbox)
$nsgDC = New-AzNetworkSecurityGroup -ResourceGroupName $RGName -Location $Location -Name "nsg-DC" -SecurityRules @(
    # Allow DNS (TCP/UDP 53) from VNet
    New-AzNetworkSecurityRuleConfig -Name "Allow-DNS-VNet" -Protocol Tcp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 53 -Access Allow -Priority 100 -Direction Inbound,
    New-AzNetworkSecurityRuleConfig -Name "Allow-DNS-UDP-VNet" -Protocol Udp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 53 -Access Allow -Priority 110 -Direction Inbound,
    # Allow LDAP (389) and LDAPS (636) from VNet
    New-AzNetworkSecurityRuleConfig -Name "Allow-LDAP-VNet" -Protocol Tcp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 389 -Access Allow -Priority 120 -Direction Inbound,
    New-AzNetworkSecurityRuleConfig -Name "Allow-LDAPS-VNet" -Protocol Tcp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 636 -Access Allow -Priority 130 -Direction Inbound,
    # Allow Kerberos (88)
    New-AzNetworkSecurityRuleConfig -Name "Allow-Kerberos-VNet" -Protocol Tcp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 88 -Access Allow -Priority 140 -Direction Inbound,
    # Allow SMB (445) from VNet (lab only)
    New-AzNetworkSecurityRuleConfig -Name "Allow-SMB-VNet" -Protocol Tcp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 445 -Access Allow -Priority 150 -Direction Inbound
)

# NSG for App/Servers (allow RDP from JumpBox/Bastion via VirtualNetwork or specific source)
$nsgServers = New-AzNetworkSecurityGroup -ResourceGroupName $RGName -Location $Location -Name "nsg-Servers" -SecurityRules @(
    New-AzNetworkSecurityRuleConfig -Name "Allow-RDP-From-VNet" -Protocol Tcp -SourceAddressPrefix VirtualNetwork -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 3389 -Access Allow -Priority 100 -Direction Inbound
)

# NSG for JumpBox (if using JumpBox) - restrict inbound RDP to Internet for lab; tighten by SourceAddressPrefix to your IP
$nsgJump = New-AzNetworkSecurityGroup -ResourceGroupName $RGName -Location $Location -Name "nsg-Jump" -SecurityRules @(
    New-AzNetworkSecurityRuleConfig -Name "Allow-RDP-From-Internet" -Protocol Tcp -SourceAddressPrefix Internet -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 3389 -Access Allow -Priority 100 -Direction Inbound
)

# -------------------------
# Create VNet and subnets
# -------------------------
Write-Host "Creating virtual network $VNetName and subnets..."
$vnet = New-AzVirtualNetwork -Name $VNetName -ResourceGroupName $RGName -Location $Location -AddressPrefix $VNetPrefix

# Add subnets (we will attach NSGs after committing the VNet)
$vnet = Add-AzVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name $SubnetDCName -AddressPrefix $SubnetDCPrefix
$vnet = Add-AzVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name $SubnetAppName -AddressPrefix $SubnetAppPref
$vnet = Add-AzVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name $SubnetJumpName -AddressPrefix $SubnetJumpPref

$vnet | Set-AzVirtualNetwork

# Refresh vnet object
$vnet = Get-AzVirtualNetwork -Name $VNetName -ResourceGroupName $RGName

# Associate NSGs to subnets
Write-Host "Associating NSGs to subnets..."
Set-AzVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name $SubnetDCName -AddressPrefix $SubnetDCPrefix -NetworkSecurityGroup $nsgDC | Out-Null
Set-AzVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name $SubnetAppName -AddressPrefix $SubnetAppPref -NetworkSecurityGroup $nsgServers | Out-Null
Set-AzVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name $SubnetJumpName -AddressPrefix $SubnetJumpPref -NetworkSecurityGroup $nsgJump | Out-Null
$vnet | Set-AzVirtualNetwork

# get subnet objects for NIC creation
$vnet = Get-AzVirtualNetwork -Name $VNetName -ResourceGroupName $RGName
$subnetDC = $vnet.Subnets | Where-Object { $_.Name -eq $SubnetDCName }
$subnetApp = $vnet.Subnets | Where-Object { $_.Name -eq $SubnetAppName }
$subnetJump = $vnet.Subnets | Where-Object { $_.Name -eq $SubnetJumpName }

# -------------------------
# Optionally create Azure Bastion or JumpBox
# -------------------------
if ($UseAzureBastion) {
    Write-Host "Deploying Azure Bastion (requires Standard SKU pip, may take several minutes)..."
    $pip = New-AzPublicIpAddress -Name "pip-bastion-$RGName" -ResourceGroupName $RGName -Location $Location -AllocationMethod Static -Sku Standard
    # create Bastion (requires the Az.Bastion cmdlets available)
    try {
        New-AzBastion -ResourceGroupName $RGName -Name "bastion-$RGName" -VirtualNetworkName $VNetName -PublicIpAddress $pip -Location $Location | Out-Null
    } catch {
        Write-Warning "Azure Bastion creation failed or Az.Bastion module not present. Install Az.Bastion or set UseAzureBastion = `$false to use a JumpBox VM."
    }
}

$jumpBoxPublicIP = $null
if (-not $UseAzureBastion -and $CreateJumpBoxVM) {
    Write-Host "Creating JumpBox VM $JumpBoxName with public IP (use to RDP into lab VMs)."
    $pip = New-AzPublicIpAddress -Name "$JumpBoxName-pip" -ResourceGroupName $RGName -Location $Location -AllocationMethod Dynamic
    $nic = New-AzNetworkInterface -Name "$JumpBoxName-nic" -ResourceGroupName $RGName -Location $Location -SubnetId $subnetJump.Id -PublicIpAddressId $pip.Id -NetworkSecurityGroupId $nsgJump.Id
    $vmConfig = New-AzVMConfig -VMName $JumpBoxName -VMSize $JumpBoxSize |
        Set-AzVMOperatingSystem -Windows -ComputerName $JumpBoxName -Credential $vmCred -ProvisionVMAgent -EnableAutoUpdate |
        Set-AzVMSourceImage -PublisherName "MicrosoftWindowsServer" -Offer "WindowsServer" -Skus "2022-Datacenter" -Version "latest" |
        Add-AzVMNetworkInterface -Id $nic.Id
    New-AzVM -ResourceGroupName $RGName -Location $Location -VM $vmConfig -Tag $Tags | Out-Null

    $jumpBoxPublicIP = (Get-AzPublicIpAddress -ResourceGroupName $RGName -Name "$JumpBoxName-pip").IpAddress
    Write-Host "Jumpbox created. Public IP: $jumpBoxPublicIP"
}

# -------------------------
# Helper: create VM function
# -------------------------
function New-PenLabVM {
    param(
        [Parameter(Mandatory=$true)][string]$Name,
        [Parameter(Mandatory=$true)][string]$SubnetName,
        [string]$PrivateIP = "",
        [string]$VMSize = "Standard_DS1_v2"
    )

    Write-Host "Creating VM: $Name on subnet: $SubnetName (private IP: $PrivateIP)"
    $vnetLocal = Get-AzVirtualNetwork -Name $VNetName -ResourceGroupName $RGName
    $subnetObj = $vnetLocal.Subnets | Where-Object { $_.Name -eq $SubnetName }
    if (-not $subnetObj) { throw "Subnet $SubnetName not present" }

    $nicName = "$Name-nic"
    if ($PrivateIP -and $PrivateIP -ne "") {
        $nic = New-AzNetworkInterface -Name $nicName -ResourceGroupName $RGName -Location $Location -SubnetId $subnetObj.Id -PrivateIpAddress $PrivateIP
    } else {
        $nic = New-AzNetworkInterface -Name $nicName -ResourceGroupName $RGName -Location $Location -SubnetId $subnetObj.Id
    }

    $vmConf = New-AzVMConfig -VMName $Name -VMSize $VMSize |
        Set-AzVMOperatingSystem -Windows -ComputerName $Name -Credential $vmCred -ProvisionVMAgent -EnableAutoUpdate |
        Set-AzVMSourceImage -PublisherName "MicrosoftWindowsServer" -Offer "WindowsServer" -Skus "2022-Datacenter" -Version "latest" |
        Add-AzVMNetworkInterface -Id $nic.Id

    New-AzVM -ResourceGroupName $RGName -Location $Location -VM $vmConf -Tag $Tags -NoAutoUpdate | Out-Null
}

# -------------------------
# Create VMs (DC + others)
# -------------------------
foreach ($vm in $VMList) {
    New-PenLabVM -Name $vm.Name -SubnetName $vm.Subnet -PrivateIP $vm.PrivateIP -VMSize $vm.Size
}

# Wait a bit for VMs to be provisioned enough for RunCommand (could be > 1-2 minutes)
Write-Host "Waiting 60 seconds for initial VM provisioning..."
Start-Sleep -Seconds 60

# -------------------------
# Promote DC to Active Directory
# -------------------------
# We'll use Invoke-AzVMRunCommand to run PowerShell on the DC VM to:
# - install AD DS role
# - run Install-ADDSForest with -DomainName and the DSRM password
#
# Security note: we pass the DSRM password as secure string into the script block.
$dcName = ($VMList | Where-Object { $_.Name -match "DC01" }).Name
if (-not $dcName) {
    Write-Warning "DC VM name not found in VMList (expected a name containing 'DC01'). Skipping AD promotion."
} else {
    Write-Host "Promoting $dcName to domain controller for domain $DomainName..."
    # Convert secure string to encrypted standard string that can be used inside Azure run command
    $dsrmPlain = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($dsrmCred))
    # The command script must run on the VM; use Install-WindowsFeature and Install-ADDSForest with -Force
    $script = @"
\$ErrorActionPreference = 'Stop'
Write-Output 'Installing AD DS feature...'
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools
Write-Output 'Importing ADDSDeployment module...'
Import-Module ADDSDeployment
Write-Output 'Creating secure string for DSRM...'
\$dsrm = ConvertTo-SecureString -String '$dsrmPlain' -AsPlainText -Force
Write-Output 'Installing AD forest: $DomainName ...'
Install-ADDSForest -DomainName '$DomainName' -DomainNetbiosName '$DomainNetbios' -SafeModeAdministratorPassword \$dsrm -CreateDnsDelegation:$false -DatabasePath "C:\Windows\NTDS" -LogPath "C:\Windows\NTDS" -SysvolPath "C:\Windows\SYSVOL" -Force
"@

    # Run the command on the DC VM
    try {
        $runResult = Invoke-AzVMRunCommand -ResourceGroupName $RGName -Name $dcName -CommandId 'RunPowerShellScript' -ScriptString $script -ErrorAction Stop
        Write-Host "AD promotion invoked. The VM will reboot as part of the promotion. Monitor in Azure portal if required."
    } catch {
        Write-Warning "Invoke-AzVMRunCommand failed: $_. Exception: $($_.Exception.Message)"
        Write-Warning "You may need to wait for VM agent readiness or perform promotion manually via RDP/PowerShell."
    } finally {
        # clear sensitive plain text
        if ($dsrmPlain) { $dsrmPlain = $null }
    }
}

# -------------------------
# Summary output
# -------------------------
Write-Host "Deployment script finished. Resource list for $RGName:"
Get-AzResource -ResourceGroupName $RGName | Select-Object ResourceType, Name | Sort-Object ResourceType | Format-Table -AutoSize

Write-Host "`nNext manual steps (if needed):"
Write-Host " - If DC promotion didn't complete, RDP into SAZE-PENLAB-DC01 (or use Bastion) and finish AD DS promotion manually."
Write-Host " - Configure DNS on VMs to point at the DC IP (10.199.1.10) if DHCP not already updated."
Write-Host " - Harden NSGs (change JumpBox source to your public IP, restrict management ports)."
Write-Host " - Enable monitoring/diagnostics/backup per policy."

# End of script