# Define your subscriptions
$subscriptions = @(
    "SUBSCRIPTION_ID_1",
    "SUBSCRIPTION_ID_2"
)

# Output file path
$outputFile = "KeyVaultSecretsReport.csv"

# Initialize results array
$results = @()

foreach ($sub in $subscriptions) {
    az account set --subscription $sub

    $keyVaults = az keyvault list --query "[].{name:name, resourceGroup:resourceGroup}" -o json | ConvertFrom-Json

    foreach ($kv in $keyVaults) {
        $vaultName = $kv.name
        $resourceGroup = $kv.resourceGroup

        # Get Key Vault tags
        $kvTags = az resource show --ids $(az keyvault show -n $vaultName --query id -o tsv) --query tags -o json | ConvertFrom-Json

        # Fallback: try getting tags from resource group if not found in KV
        if (-not $kvTags) {
            $kvTags = az group show --name $resourceGroup --query tags -o json | ConvertFrom-Json
        }

        $owner = $null
        foreach ($key in "PrimaryContact", "primaryContact", "primary_contact") {
            if ($kvTags.ContainsKey($key)) {
                $owner = $kvTags[$key]
                break
            }
        }

        if (-not $owner) {
            $owner = "Unknown"
        }

        $secrets = az keyvault secret list --vault-name $vaultName --query "[].name" -o json | ConvertFrom-Json

        foreach ($secret in $secrets) {
            $results += [PSCustomObject]@{
                Subscription   = $sub
                KeyVaultName   = $vaultName
                SecretName     = $secret
                ResourceGroup  = $resourceGroup
                Owner          = $owner
            }
        }
    }
}

# Export to CSV
$results | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8

Write-Host "CSV report saved to $outputFile"
