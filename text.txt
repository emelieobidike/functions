# Connect to Azure
Connect-AzAccount

# Get all subscriptions
$subscriptions = Get-AzSubscription

# Prepare results array
$results = @()

foreach ($sub in $subscriptions) {
    Write-Host "Processing subscription: $($sub.Name)" -ForegroundColor Cyan
    Set-AzContext -SubscriptionId $sub.Id

    # Get all storage accounts in this subscription
    $storageAccounts = Get-AzStorageAccount

    foreach ($sa in $storageAccounts) {
        Write-Host "  Checking storage account: $($sa.StorageAccountName)" -ForegroundColor Yellow

        # Get the context for this storage account
        $ctx = $sa.Context

        # Initialize blob counter
        $blobCount = 0

        # Get all containers in the storage account
        $containers = Get-AzStorageContainer -Context $ctx

        foreach ($container in $containers) {
            # List blobs in the container and count them
            $blobs = Get-AzStorageBlob -Container $container.Name -Context $ctx
            $blobCount += $blobs.Count
        }

        # Add to results
        $results += [PSCustomObject]@{
            SubscriptionName   = $sub.Name
            ResourceGroupName  = $sa.ResourceGroupName
            StorageAccountName = $sa.StorageAccountName
            BlobCount          = $blobCount
        }
    }
}

# Display summary
$results | Format-Table -AutoSize

# Optionally export to CSV
$results | Export-Csv -Path "./BlobCountSummary.csv" -NoTypeInformation

Write-Host "âœ… Blob count completed. Results exported to BlobCountSummary.csv"