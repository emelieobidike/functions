<#
Name:    deploy_penlab.ps1
Version: 1.0
Author:  Anthonyâ€™s AI Sidekick
Date:    2025-1-18
Purpose: Deploy Penetration Lab Infrastructure (Staging)

Pre-req: Latest Az modules, existing Subscription & MG
#>

Update-AzConfig -EnableLoginByWam $false

# -------- Connect to tenant + subscription --------
Connect-AzAccount -Subscription sub_Infosec -Tenant ssbstg.onmicrosoft.com

# -------- Region Toggle --------
$locName = "eastus2"
$regName = "eus2"
$tntName = "stg"

# -------- Naming --------
$projName = "PenLab"
$rgName = "rg_${regName}_${projName}"
$vnetName = "vnet_${regName}_${projName}"
$snName = "snet_${regName}_${projName}"
$rtName = "rt_${regName}_${projName}"
$nsgName = "nsg_${regName}_${projName}"

# -------- Network Prefixes --------
$addrSpace = "10.199.70.96/27"
$subnetPrefix = "10.199.70.96/27"

# -------- Create Resource Group --------
Set-AzContext -Subscription sub_Infosec
New-AzResourceGroup -Name $rgName -Location $locName

# -------- Route Table --------
$rt = New-AzRouteTable -Name $rtName -ResourceGroupName $rgName -Location $locName

# -------- NSG --------
$nsg = New-AzNetworkSecurityGroup -Name $nsgName -ResourceGroupName $rgName -Location $locName

# Inbound deny
$p = @{
    NetworkSecurityGroup = $nsg
    Direction = "Inbound"
    Priority = 4096
    Name = "Deny-All-In"
    SourceAddressPrefix = "*"
    SourcePortRange = "*"
    DestinationAddressPrefix = "*"
    DestinationPortRange = "*"
    Protocol = "*"
    Access = "Deny"
}
Add-AzNetworkSecurityRuleConfig @p

# Outbound deny
$p = @{
    NetworkSecurityGroup = $nsg
    Direction = "Outbound"
    Priority = 4096
    Name = "Deny-All-Out"
    SourceAddressPrefix = "*"
    SourcePortRange = "*"
    DestinationAddressPrefix = "*"
    DestinationPortRange = "*"
    Protocol = "*"
    Access = "Deny"
}
Add-AzNetworkSecurityRuleConfig @p

Set-AzNetworkSecurityGroup -NetworkSecurityGroup $nsg

# -------- VNet + Subnet --------
$p = @{
    Name = $vnetName
    ResourceGroup = $rgName
    Location = $locName
    AddressPrefix = $addrSpace
}
$vnet = New-AzVirtualNetwork @p

$p = @{
    VirtualNetwork = $vnet
    Name = $snName
    AddressPrefix = $subnetPrefix
    NetworkSecurityGroup = $nsg
    RouteTable = $rt
}
Add-AzVirtualNetworkSubnetConfig @p

$vnet = Set-AzVirtualNetwork -VirtualNetwork $vnet

# -------- VM Definitions --------
$adminUser = "locala"
$winPassword = Read-Host -Prompt "Enter password for Windows VMs" -AsSecureString
$sshKey = Get-Content -Path "~/.ssh/id_rsa.pub"

$vmList = @(
    @{ Name="SAZS-PENLAB-DC01"; Image="MicrosoftWindowsServer:WindowsServer:2022-datacenter:latest"; Boot="07:00"; Shutdown="19:00" }
    @{ Name="SAZS-PENLAB-H01";  Image="MicrosoftWindowsServer:WindowsServer:2022-datacenter:latest"; Boot="07:05"; Shutdown="19:00" }
    @{ Name="SAZS-PENLAB-S19";  Image="MicrosoftWindowsServer:WindowsServer:2022-datacenter:latest"; Boot="07:05"; Shutdown="19:00" }
    @{ Name="SAZS-PENLAB-S22";  Image="MicrosoftWindowsServer:WindowsServer:2022-datacenter:latest"; Boot="07:05"; Shutdown="19:00" }
    @{ Name="SAZS-PENLAB-LNX01"; Image="RedHat:RHEL:9-lvm-gen2:latest"; Boot="07:05"; Shutdown="19:00" }
)

# -------- Deploy VMs --------
foreach($vm in $vmList) {

    $nicName = "nic_$($vm.Name)"
    $ipName = "ip_$($vm.Name)"

    # Public IP (None for PenLab)
    $pip = New-AzPublicIpAddress -Name $ipName -ResourceGroupName $rgName -Location $locName -Sku Basic -AllocationMethod Static

    # NIC
    $nic = New-AzNetworkInterface -Name $nicName -ResourceGroupName $rgName -Location $locName -SubnetId $vnet.Subnets[0].Id -PublicIpAddress $pip

    # VM config
    $vmConfig = New-AzVMConfig -VMName $vm.Name -VMSize "Standard_DS1_v2"

    if($vm.Name -eq "SAZS-PENLAB-LNX01"){
        # Linux
        $vmConfig = Set-AzVMOperatingSystem -VM $vmConfig -Linux -ComputerName $vm.Name -Credential (New-Object System.Management.Automation.PSCredential($adminUser,(ConvertTo-SecureString "placeholder" -AsPlainText -Force))) -DisablePasswordAuthentication
        $vmConfig = Set-AzVMSourceImage -VM $vmConfig -PublisherName ($vm.Image.Split(":")[0]) -Offer ($vm.Image.Split(":")[1]) -Skus ($vm.Image.Split(":")[2]) -Version "latest"
        Add-AzVMSSHKey -VM $vmConfig -KeyData $sshKey -Path "/home/$adminUser/.ssh/authorized_keys"
    }
    else {
        # Windows
        $cred = New-Object System.Management.Automation.PSCredential($adminUser, $winPassword)
        $vmConfig = Set-AzVMOperatingSystem -VM $vmConfig -Windows -ComputerName $vm.Name -Credential $cred
        $vmConfig = Set-AzVMSourceImage -VM $vmConfig -PublisherName ($vm.Image.Split(":")[0]) -Offer ($vm.Image.Split(":")[1]) -Skus ($vm.Image.Split(":")[2]) -Version "latest"
    }

    $vmConfig = Add-AzVMNetworkInterface -VM $vmConfig -Id $nic.Id

    New-AzVM -ResourceGroupName $rgName -Location $locName -VM $vmConfig
}

# -------- Auto Start/Stop Schedules --------
foreach($vm in $vmList){

    $autoRg = $rgName

    # BOOT
    New-AzAutomationScheduledRunbook -ResourceGroupName $autoRg `
        -AutomationAccountName "AA-PenLab" `
        -Name "start_$($vm.Name)" `
        -ScheduleName "sch_start_$($vm.Name)" `
        -RunbookName "Start-AzVM" `
        -Parameters @{ ResourceGroupName=$rgName; Name=$vm.Name }

    # SHUTDOWN
    New-AzAutomationScheduledRunbook -ResourceGroupName $autoRg `
        -AutomationAccountName "AA-PenLab" `
        -Name "stop_$($vm.Name)" `
        -ScheduleName "sch_stop_$($vm.Name)" `
        -RunbookName "Stop-AzVM" `
        -Parameters @{ ResourceGroupName=$rgName; Name=$vm.Name }
}

Write-Output "PenLab build complete."