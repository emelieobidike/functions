param(
    [string]$ResourceGroupName,
    [string[]]$VMNames,
    [ValidateSet("Start", "Stop")]
    [string]$Action
)

Write-Output "=== DEBUG RUN START ==="
Write-Output "ResourceGroupName = $ResourceGroupName"
Write-Output "VMNames = $($VMNames -join ', ')"
Write-Output "Action = $Action"

Connect-AzAccount -Identity
Write-Output "Authenticated as:"
(Get-AzContext).Account | Format-List

foreach ($vmName in $VMNames) {

    Write-Output "Trying to get VM: $vmName"

    try {
        $vm = Get-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -ErrorAction Stop
        Write-Output "Found VM: $($vm.Name)"
    }
    catch {
        Write-Output "‚ùå FAILED to get VM: $vmName"
        Write-Output "ERROR: $($_.Exception.Message)"
        throw  # force job to surface the error
    }
}

Write-Output "=== DEBUG RUN END ==="