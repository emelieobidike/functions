$vms = Get-AzVM -Status
$unencryptedVms = $vms | Where-Object { -not $_.StorageProfile.EncryptionAtHost }

# Export to CSV
$unencryptedVms | Select-Object Name, ResourceGroupName, Location | Export-Csv -Path "UnencryptedVMs.csv" -NoTypeInformation -Encoding UTF8

Write-Host "Data exported to UnencryptedVMs.csv"