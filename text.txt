param (
    [string]$OutputFile = "exported_config.auto.tfvars.json"
)

# NOTE: Ensure the executing account has at least 'Policy Reader' or 'Reader' role on all target subscriptions.

function Get-AllSubscriptions {
    az account list --query "[].{id:id, name:name}" -o json | ConvertFrom-Json
}

function Get-PolicyAssignmentsForScope($scope) {
    az policy assignment list --scope $scope | ConvertFrom-Json
}

function Get-InitiativeAssignmentsForScope($scope) {
    az policy assignment list --scope $scope --query "[?policyDefinitionId.contains(@, 'policySetDefinitions')]" | ConvertFrom-Json
}

function Get-FormattedAssignment($assignment) {
    return @{
        name                  = $assignment.name
        is_custom             = $false
        policy_definition_id  = $assignment.policyDefinitionId
        policy_key            = $null
        enforcement           = ($assignment.enforcementMode -eq "Default")
        parameters            = if ($assignment.parameters) { $assignment.parameters | ConvertTo-Json -Compress } else { "{}" }
    }
}

$output = @{
    policies    = @{}
    initiatives = @{}
    exemptions  = @{}
}

$subscriptions = Get-AllSubscriptions
foreach ($sub in $subscriptions) {
    $subId = $sub.id
    $subName = $sub.name
    Write-Output "`nProcessing subscription: $subName"
    az account set --subscription $subId
    Write-Output "Set context to subscription $subName"

    $subScope = "/subscriptions/$subId"

    # DEBUG: Show all raw policy assignments
    $rawAssignments = Get-PolicyAssignmentsForScope -scope $subScope
    Write-Output "DEBUG: Total assignments (raw): $($rawAssignments.Count)"
    foreach ($ra in $rawAssignments) {
        Write-Output "DEBUG: $($ra.name) - $($ra.policyDefinitionId)"
    }

    # Process individual policy assignments (not part of initiatives)
    $assignments = $rawAssignments | Where-Object {
        $_.policyDefinitionId -notlike "*policySetDefinitions*"
    }
    Write-Output "Found $($assignments.Count) policy assignments (not part of initiatives)"

    if ($assignments.Count -gt 0) {
        $output.policies[$subName] = @{
            scope_type         = "subscription"
            scope_id           = $subScope
            policy_assignments = @()
        }

        foreach ($a in $assignments) {
            $output.policies[$subName].policy_assignments += Get-FormattedAssignment -assignment $a
        }
    }

    # Process initiatives
    $initiatives = Get-InitiativeAssignmentsForScope -scope $subScope
    Write-Output "Found $($initiatives.Count) initiative assignments"
    foreach ($i in $initiatives) {
        Write-Output "INITIATIVE DEBUG: $($i.name) - $($i.policyDefinitionId)"
    }

    if ($initiatives.Count -gt 0) {
        $output.initiatives[$subName] = @{
            scope_type         = "subscription"
            scope_id           = $subScope
            policy_assignments = @()
        }

        foreach ($i in $initiatives) {
            $output.initiatives[$subName].policy_assignments += Get-FormattedAssignment -assignment $i
        }
    }
}

Write-Output "`nFinished processing all subscriptions."

$output | ConvertTo-Json -Depth 10 | Out-File -Encoding utf8 -FilePath $OutputFile
Write-Output "Policy and initiative assignments exported to $OutputFile"
