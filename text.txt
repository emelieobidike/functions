param(
    [string]$ResourceGroupName,
    [string]$VMNames,
    [string]$Action
)

$ErrorActionPreference = "Stop"

# Normalize parameters
$ResourceGroupName = $ResourceGroupName.Trim()
$Action = $Action.Trim().ToLower()
$VMNames = $VMNames.Split(",") | ForEach-Object { $_.Trim() }

Write-Output "Starting runbook..."
Write-Output "Resource Group: $ResourceGroupName"
Write-Output "VMs: $($VMNames -join ', ')"
Write-Output "Action: $Action"

Connect-AzAccount -Identity

foreach ($vmName in $VMNames) {
    Write-Output "`nProcessing VM: $vmName"

    $vm = Get-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -ErrorAction Stop

    switch ($Action) {
        "start" {
            Write-Output "Starting $vmName..."
            Start-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -ErrorAction Stop
        }
        "stop" {
            Write-Output "Stopping $vmName..."
            Stop-AzVM -Name $vmName -ResourceGroupName $ResourceGroupName -Force -ErrorAction Stop
        }
        default {
            throw "Invalid action '$Action'. Use Start or Stop."
        }
    }

    Write-Output "$vmName: Completed action '$Action'"
}

Write-Output "`nRunbook completed successfully."