$managementGroupId = "<YourManagementGroupId>"
$policyAssignmentName = "<PolicyAssignmentName>"
$output = @()

# Get all subscriptions under the management group
$subscriptions = Get-AzSubscription | Where-Object { $_.Id -in (Get-AzManagementGroupSubscription -GroupId $managementGroupId).Id }

foreach ($sub in $subscriptions) {
    Set-AzContext -SubscriptionId $sub.Id

    $exemptions = Get-AzPolicyExemption | Where-Object { $_.PolicyAssignmentId -like "*$policyAssignmentName*" }

    foreach ($ex in $exemptions) {
        if ($ex.ExpiresOn -and $ex.ExpiresOn -lt (Get-Date)) {
            $output += [PSCustomObject]@{
                SubscriptionId = $sub.Id
                Name           = $ex.Name
                Scope          = $ex.Scope
                ExpiresOn      = $ex.ExpiresOn
                PolicyAssignmentId = $ex.PolicyAssignmentId
            }
        }
    }
}

# Export to CSV
$output | Export-Csv -Path "./expired-policy-exemptions.csv" -NoTypeInformation
Write-Host "Exported expired exemptions to expired-policy-exemptions.csv"