$subscriptionIds = @("subscription-id1", "subscription-id2", ..., "subscription-id8")
$vmInfoList = @()

foreach ($subscriptionId in $subscriptionIds) {
    # Connect to Azure using your subscription
    Connect-AzAccount -SubscriptionId $subscriptionId

    # Get all VMs in the subscription
    $vms = Get-AzVM

    foreach ($vm in $vms) {
        $vmInfo = New-Object PSObject
        $vmInfo.Name = $vm.Name
        $vmInfo.ResourceGroup = $vm.ResourceGroup
        $vmInfo.SubscriptionId = $subscriptionId

        # Get owner and DR Tier from tags
        $vmInfo.Owner = (Get-AzResourceTag -Resource $vm).PrimaryContact ?: (Get-AzResourceTag -Resource $vm).primarycontact
        $vmInfo.DrTier = Get-AzResourceTag -Resource $vm | Where-Object {$_.Name -eq "DRTier"} | Select-Object Value

        # Check for encryption at host using virtual machine extension for each disk
        $hasHostEncryption = (Get-AzVMExtension -VMName $vm.Name -ResourceGroupName $vm.ResourceGroup | Where-Object {$_.Name -like "*AzureDiskEncryption*"}).Count -gt 0
        if (!$hasHostEncryption) {
            $vmInfoList += $vmInfo
        }
    }
}

# Convert list to DataTable for easier CSV export
$dataTable = New-Object DataTable($vmInfoList[0].PsObject.Properties.GetKeys())
$vmInfoList | ForEach-Object { $dataTable.Rows.Add($_.Name, $_.ResourceGroup, $_.SubscriptionId, $_.Owner, $_.DrTier) }

# Export data table to CSV file
$dataTable.ExportToCsv("VMsWithoutHostEncryption.csv") -NoTypeInformation
