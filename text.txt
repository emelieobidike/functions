# Connect to Azure if not already connected
if (-not (Get-AzContext)) {
    Connect-AzAccount
}

# Get all subscriptions
$subscriptions = Get-AzSubscription

# Initialize an array to store VMs with diagnostic logs enabled
$diagnosticVMs = @()

foreach ($subscription in $subscriptions) {
    # Set the current subscription
    Set-AzContext -SubscriptionId $subscription.Id

    # Get all VMs in the subscription
    $vms = Get-AzVM

    foreach ($vm in $vms) {
        # Get diagnostic settings for the VM
        $diagnosticSettings = Get-AzDiagnosticSetting -ResourceId $vm.Id -ErrorAction SilentlyContinue

        if ($diagnosticSettings) {
            # If diagnostic settings exist, add the VM to the list
            $diagnosticVMs += [PSCustomObject]@{
                Subscription   = $subscription.Name
                ResourceGroup  = $vm.ResourceGroupName
                VMName         = $vm.Name
                Location       = $vm.Location
            }
        }
    }
}

# Output the results
if ($diagnosticVMs.Count -gt 0) {
    $diagnosticVMs | Format-Table -AutoSize
} else {
    Write-Host "No VMs with diagnostic logs enabled found."
}

# Optionally, export the results to a CSV file
$diagnosticVMs | Export-Csv -Path "VMsWithDiagnosticLogs.csv" -NoTypeInformation
Write-Host "Results exported to VMsWithDiagnosticLogs.csv"