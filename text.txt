# ================================
# Script: Get-KeyVaultOwners.ps1
# Purpose: Export Key Vaults and their PrimaryContact owners from multiple subscriptions
# ================================

# List of subscriptions to check
$subscriptions = @(
    "sub1-guid-or-name",
    "sub2-guid-or-name",
    "sub3-guid-or-name",
    "sub4-guid-or-name",
    "sub5-guid-or-name",
    "sub6-guid-or-name"
)

# Output file
$outputFile = "KeyVaultOwners.csv"

# Empty array to store results
$results = @()

# Ensure Az module is available
if (-not (Get-Module -ListAvailable -Name Az.Accounts)) {
    Write-Host "Installing Az module..."
    Install-Module Az -Scope CurrentUser -Force
}

Import-Module Az.Accounts
Import-Module Az.KeyVault
Import-Module Az.Resources

# Login (only once)
Connect-AzAccount -ErrorAction Stop

foreach ($sub in $subscriptions) {
    Write-Host "Processing subscription: $sub" -ForegroundColor Cyan
    Set-AzContext -Subscription $sub | Out-Null

    # Get all Key Vaults
    $keyVaults = Get-AzKeyVault

    foreach ($kv in $keyVaults) {
        $owner = $null

        # Try to get PrimaryContact tag from Key Vault
        if ($kv.Tags.ContainsKey("PrimaryContact")) {
            $owner = $kv.Tags["PrimaryContact"]
        } else {
            # Get the Resource Group and check for tag there
            $rg = Get-AzResourceGroup -Name $kv.ResourceGroupName -ErrorAction SilentlyContinue
            if ($rg -and $rg.Tags.ContainsKey("PrimaryContact")) {
                $owner = $rg.Tags["PrimaryContact"]
            } else {
                $owner = "Not Defined"
            }
        }

        # Collect info
        $results += [PSCustomObject]@{
            Subscription    = $sub
            ResourceGroup   = $kv.ResourceGroupName
            KeyVaultName    = $kv.VaultName
            Location        = $kv.Location
            Owner           = $owner
        }
    }
}

# Export results to CSV
$results | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8

Write-Host "âœ… Export complete. File saved to: $outputFile" -ForegroundColor Green
